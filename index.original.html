<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SoundForge ‚Äî Interactive Music Studio</title>
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Sora:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0a0a0f;
        --surface: #12121a;
        --surface2: #1a1a26;
        --surface3: #222233;
        --border: #2a2a3a;
        --text: #e8e8f0;
        --text-dim: #8888aa;
        --accent: #ff6b3d;
        --accent-glow: rgba(255, 107, 61, 0.3);
        --kick: #ff4466;
        --snare: #44aaff;
        --hihat: #ffcc33;
        --bass: #44ff88;
        --synth1: #cc66ff;
        --synth2: #ff66aa;
        --pad: #66ccff;
        --fx: #ff9944;
        --cell-size: 38px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Sora', sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Subtle grid background */
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image:
          linear-gradient(rgba(255, 107, 61, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 107, 61, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
        z-index: 0;
      }

      .app {
        position: relative;
        z-index: 1;
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: rgba(10, 10, 15, 0.9);
        backdrop-filter: blur(20px);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: var(--accent);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        box-shadow: 0 0 20px var(--accent-glow);
      }

      .logo h1 {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .logo h1 span {
        color: var(--accent);
      }

      /* Transport Controls */
      .transport {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .transport-btn {
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text);
        width: 42px;
        height: 42px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.2s;
      }

      .transport-btn:hover {
        border-color: var(--accent);
        background: var(--surface3);
      }
      .transport-btn.playing {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
        box-shadow: 0 0 20px var(--accent-glow);
      }

      .bpm-control {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 14px;
        font-family: 'JetBrains Mono', monospace;
      }

      .bpm-control label {
        font-size: 11px;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .bpm-control input {
        background: none;
        border: none;
        color: var(--accent);
        font-family: 'JetBrains Mono', monospace;
        font-size: 18px;
        font-weight: 700;
        width: 48px;
        text-align: center;
        outline: none;
      }

      .bpm-control input::-webkit-inner-spin-button {
        -webkit-appearance: none;
      }

      /* Main Layout */
      .main {
        display: flex;
        height: calc(100vh - 75px);
      }

      /* Sidebar - Education Panel */
      .sidebar {
        width: 300px;
        min-width: 300px;
        border-right: 1px solid var(--border);
        background: var(--surface);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
      }

      .sidebar-tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-dim);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        background: none;
        border-top: none;
        border-left: none;
        border-right: none;
      }

      .sidebar-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .sidebar-tab:hover {
        color: var(--text);
      }

      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }

      .sidebar-content::-webkit-scrollbar {
        width: 4px;
      }
      .sidebar-content::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }

      .learn-card {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .learn-card:hover {
        border-color: var(--accent);
        transform: translateY(-1px);
      }
      .learn-card.expanded {
        border-color: var(--accent);
      }

      .learn-card h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .learn-card .tag {
        font-size: 9px;
        padding: 2px 8px;
        border-radius: 20px;
        background: rgba(255, 107, 61, 0.15);
        color: var(--accent);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .learn-card p {
        font-size: 13px;
        color: var(--text-dim);
        line-height: 1.6;
      }

      .learn-card .detail {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-dim);
        line-height: 1.7;
        border-top: 1px solid var(--border);
        padding-top: 10px;
        display: none;
      }

      .learn-card.expanded .detail {
        display: block;
      }

      .learn-card .detail strong {
        color: var(--text);
      }

      /* Preset Section */
      .preset-btn {
        display: block;
        width: 100%;
        padding: 12px 16px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-family: 'Sora', sans-serif;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 8px;
        text-align: left;
        transition: all 0.2s;
      }

      .preset-btn:hover {
        border-color: var(--accent);
        background: var(--surface3);
      }
      .preset-btn span {
        color: var(--text-dim);
        font-size: 11px;
        display: block;
        margin-top: 4px;
      }

      /* Grid Area */
      .grid-area {
        flex: 1;
        overflow: auto;
        padding: 20px;
      }

      .grid-area::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .grid-area::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }

      /* Instrument Row */
      .instrument-row {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
        gap: 2px;
      }

      .instrument-label {
        width: 110px;
        min-width: 110px;
        padding: 6px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .instrument-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .instrument-controls {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: 6px;
      }

      .vol-slider {
        -webkit-appearance: none;
        width: 50px;
        height: 3px;
        background: var(--border);
        border-radius: 2px;
        outline: none;
      }

      .vol-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-dim);
        cursor: pointer;
      }

      .mute-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        font-size: 14px;
        padding: 2px;
        opacity: 0.7;
        transition: 0.2s;
      }

      .mute-btn:hover {
        opacity: 1;
      }
      .mute-btn.muted {
        color: var(--kick);
        opacity: 1;
      }

      /* Grid Cells */
      .beat-cell {
        width: var(--cell-size);
        height: var(--cell-size);
        min-width: var(--cell-size);
        border-radius: 6px;
        border: 1px solid transparent;
        background: var(--surface2);
        cursor: pointer;
        transition: all 0.1s;
        position: relative;
      }

      .beat-cell:hover {
        background: var(--surface3);
        border-color: var(--border);
      }

      .beat-cell.active {
        animation: cellPop 0.15s ease;
      }

      .beat-cell.playing-col {
        background: rgba(255, 255, 255, 0.04) !important;
      }

      .beat-cell.playing-col.active {
        filter: brightness(1.4);
        box-shadow: 0 0 12px var(--accent-glow);
      }

      @keyframes cellPop {
        0% {
          transform: scale(0.85);
        }
        60% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Beat markers */
      .beat-markers {
        display: flex;
        margin-left: 110px;
        margin-bottom: 6px;
        gap: 2px;
      }

      .beat-marker {
        width: var(--cell-size);
        min-width: var(--cell-size);
        text-align: center;
        font-size: 9px;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-dim);
        padding: 2px 0;
      }

      .beat-marker.downbeat {
        color: var(--accent);
        font-weight: 700;
      }

      /* Scale / Key Selector */
      .controls-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 20px;
        border-bottom: 1px solid var(--border);
        background: rgba(18, 18, 26, 0.8);
        flex-wrap: wrap;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-group label {
        font-size: 11px;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .control-select {
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 12px;
        border-radius: 8px;
        font-family: 'Sora', sans-serif;
        font-size: 13px;
        cursor: pointer;
        outline: none;
      }

      .control-select:focus {
        border-color: var(--accent);
      }

      .clear-btn {
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text-dim);
        padding: 6px 14px;
        border-radius: 8px;
        font-family: 'Sora', sans-serif;
        font-size: 12px;
        cursor: pointer;
        transition: 0.2s;
        margin-left: auto;
      }

      .clear-btn:hover {
        border-color: var(--kick);
        color: var(--kick);
      }

      /* Piano Roll */
      .piano-section {
        margin-top: 20px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
      }

      .piano-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
      }

      .piano-header h3 {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .piano-keys {
        display: flex;
        padding: 16px;
        gap: 2px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .piano-key {
        width: 42px;
        height: 120px;
        border-radius: 0 0 6px 6px;
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 8px;
        font-size: 10px;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        transition: all 0.1s;
        position: relative;
      }

      .piano-key.white {
        background: linear-gradient(180deg, #e8e8f0 0%, #d0d0da 100%);
        color: #444;
      }

      .piano-key.black {
        background: linear-gradient(180deg, #333 0%, #1a1a1a 100%);
        color: #888;
        width: 30px;
        height: 80px;
        margin: 0 -15px;
        z-index: 2;
        border-radius: 0 0 4px 4px;
      }

      .piano-key:active,
      .piano-key.pressed {
        transform: scaleY(0.98);
        filter: brightness(0.85);
      }

      .piano-key.in-scale::after {
        content: '';
        position: absolute;
        bottom: 4px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent);
      }

      /* Chord display */
      .chord-display {
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chord-btn {
        padding: 8px 16px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        cursor: pointer;
        transition: 0.2s;
      }

      .chord-btn:hover {
        border-color: var(--accent);
        background: var(--surface3);
      }
      .chord-btn:active {
        background: var(--accent);
        color: #fff;
      }
      .chord-btn .roman {
        font-size: 10px;
        color: var(--text-dim);
        display: block;
      }

      /* Info tooltip */
      .tooltip {
        position: fixed;
        background: var(--surface3);
        border: 1px solid var(--accent);
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 12px;
        color: var(--text);
        max-width: 240px;
        z-index: 999;
        pointer-events: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        display: none;
      }

      /* Responsive */
      @media (max-width: 900px) {
        .sidebar {
          display: none;
        }
        .main {
          flex-direction: column;
        }
      }

      /* Visualizer */
      .visualizer {
        height: 60px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }

      .visualizer canvas {
        width: 100%;
        height: 100%;
      }

      /* Section dividers in grid */
      .section-divider {
        width: 2px;
        min-width: 2px;
        height: var(--cell-size);
        background: var(--border);
        border-radius: 1px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Header -->
      <div class="header">
        <div class="logo">
          <div class="logo-icon">‚ô™</div>
          <h1>Sound<span>Forge</span></h1>
        </div>
        <div class="transport">
          <div class="bpm-control">
            <label>BPM</label>
            <input
              type="number"
              id="bpmInput"
              value="120"
              min="40"
              max="240"
              step="1"
            />
          </div>
          <button class="transport-btn" id="playBtn" title="Play/Stop">
            ‚ñ∂
          </button>
          <button class="transport-btn" id="recBtn" title="Record to WAV">
            ‚è∫
          </button>
        </div>
      </div>

      <!-- Visualizer -->
      <div class="visualizer">
        <canvas id="vizCanvas"></canvas>
      </div>

      <!-- Main -->
      <div class="main">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="sidebar-tabs">
            <button class="sidebar-tab active" data-tab="learn">Learn</button>
            <button class="sidebar-tab" data-tab="presets">Presets</button>
            <button class="sidebar-tab" data-tab="tips">Tips</button>
          </div>
          <div class="sidebar-content" id="sidebarContent"></div>
        </div>

        <!-- Grid -->
        <div
          style="
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
          "
        >
          <div class="controls-bar">
            <div class="control-group">
              <label>Key</label>
              <select class="control-select" id="keySelect"></select>
            </div>
            <div class="control-group">
              <label>Scale</label>
              <select class="control-select" id="scaleSelect"></select>
            </div>
            <div class="control-group">
              <label>Swing</label>
              <input
                type="range"
                class="vol-slider"
                id="swingSlider"
                min="0"
                max="80"
                value="0"
                style="width: 80px"
              />
              <span
                id="swingVal"
                style="
                  font-family: 'JetBrains Mono';
                  font-size: 12px;
                  color: var(--text-dim);
                "
                >0%</span
              >
            </div>
            <button class="clear-btn" id="clearBtn">Clear All</button>
            <button class="clear-btn" id="randomBtn" style="margin-left: 0">
              üé≤ Random
            </button>
          </div>
          <div class="grid-area" id="gridArea">
            <div class="beat-markers" id="beatMarkers"></div>
            <div id="drumGrid"></div>
            <div class="piano-section">
              <div class="piano-header">
                <h3>
                  üéπ Keyboard
                  <span
                    style="
                      font-size: 11px;
                      color: var(--text-dim);
                      font-weight: 400;
                    "
                    >‚Äî click or use keys A-L</span
                  >
                </h3>
                <div class="control-group">
                  <label>Octave</label>
                  <select class="control-select" id="octaveSelect">
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                  </select>
                </div>
              </div>
              <div class="piano-keys" id="pianoKeys"></div>
              <div class="chord-display" id="chordDisplay"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
      // ============== AUDIO ENGINE ==============
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      let audioCtx = null;
      let masterGain = null;
      let analyser = null;

      function initAudio() {
        if (audioCtx) return;
        audioCtx = new AudioCtx();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.7;
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        masterGain.connect(analyser);
        analyser.connect(audioCtx.destination);
      }

      // ============== INSTRUMENTS ==============
      const instruments = [
        { id: 'kick', name: 'Kick', color: 'var(--kick)', type: 'drum' },
        { id: 'snare', name: 'Snare', color: 'var(--snare)', type: 'drum' },
        { id: 'hihat', name: 'HiHat', color: 'var(--hihat)', type: 'drum' },
        { id: 'bass', name: 'Bass', color: 'var(--bass)', type: 'tone' },
        { id: 'synth1', name: 'Synth1', color: 'var(--synth1)', type: 'tone' },
        { id: 'synth2', name: 'Synth2', color: 'var(--synth2)', type: 'tone' },
        { id: 'pad', name: 'Pad', color: 'var(--pad)', type: 'tone' },
        { id: 'fx', name: 'FX', color: 'var(--fx)', type: 'fx' },
      ];

      const STEPS = 16;
      let grid = {};
      let volumes = {};
      let muted = {};

      instruments.forEach((inst) => {
        grid[inst.id] = new Array(STEPS).fill(false);
        volumes[inst.id] = 0.7;
        muted[inst.id] = false;
      });

      // ============== MUSIC THEORY ==============
      const NOTE_NAMES = [
        'C',
        'C#',
        'D',
        'D#',
        'E',
        'F',
        'F#',
        'G',
        'G#',
        'A',
        'A#',
        'B',
      ];

      const SCALES = {
        Major: [0, 2, 4, 5, 7, 9, 11],
        Minor: [0, 2, 3, 5, 7, 8, 10],
        Pentatonic: [0, 2, 4, 7, 9],
        Blues: [0, 3, 5, 6, 7, 10],
        Dorian: [0, 2, 3, 5, 7, 9, 10],
        Mixolydian: [0, 2, 4, 5, 7, 9, 10],
        'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11],
        Phrygian: [0, 1, 3, 5, 7, 8, 10],
      };

      let currentKey = 0; // C
      let currentScale = 'Major';
      let currentOctave = 4;

      function getScaleNotes(key, scaleName) {
        const intervals = SCALES[scaleName];
        return intervals.map((i) => (key + i) % 12);
      }

      function noteFreq(note, octave) {
        return 440 * Math.pow(2, (note - 9 + (octave - 4) * 12) / 12);
      }

      // Chord generation
      function getChords(key, scaleName) {
        const scale = SCALES[scaleName];
        const romanMajor = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
        const romanMinor = ['i', 'ii', 'iii', 'iv', 'v', 'vi', 'vii'];
        const chords = [];

        for (let i = 0; i < scale.length; i++) {
          const root = (key + scale[i]) % 12;
          const thirdIdx = (i + 2) % scale.length;
          const fifthIdx = (i + 4) % scale.length;

          let third = (key + scale[thirdIdx]) % 12;
          let fifth = (key + scale[fifthIdx]) % 12;

          const thirdInterval = (third - root + 12) % 12;
          const isMinor = thirdInterval === 3;
          const isDim = thirdInterval === 3 && (fifth - root + 12) % 12 === 6;

          chords.push({
            name: NOTE_NAMES[root] + (isDim ? 'dim' : isMinor ? 'm' : ''),
            roman: isDim
              ? romanMinor[i] + '¬∞'
              : isMinor
                ? romanMinor[i]
                : romanMajor[i],
            notes: [root, third, fifth],
          });
        }
        return chords;
      }

      // Bass note mapping per step (for tonal instruments)
      function getStepNote(instId, step) {
        const scaleNotes = getScaleNotes(currentKey, currentScale);
        const numNotes = scaleNotes.length;

        switch (instId) {
          case 'bass':
            return { note: scaleNotes[step % numNotes], octave: 2 };
          case 'synth1':
            return { note: scaleNotes[step % numNotes], octave: 4 };
          case 'synth2':
            return { note: scaleNotes[(step * 2) % numNotes], octave: 4 };
          case 'pad':
            return {
              note: scaleNotes[Math.floor(step / 4) % numNotes],
              octave: 3,
            };
          default:
            return { note: scaleNotes[0], octave: 4 };
        }
      }

      // ============== SOUND SYNTHESIS ==============
      function playKick(time) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(160, time);
        osc.frequency.exponentialRampToValueAtTime(40, time + 0.12);
        gain.gain.setValueAtTime(1, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.3);
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(time);
        osc.stop(time + 0.3);
      }

      function playSnare(time) {
        // Noise
        const bufferSize = audioCtx.sampleRate * 0.1;
        const buffer = audioCtx.createBuffer(
          1,
          bufferSize,
          audioCtx.sampleRate,
        );
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;

        const noiseGain = audioCtx.createGain();
        noiseGain.gain.setValueAtTime(0.6, time);
        noiseGain.gain.exponentialRampToValueAtTime(0.001, time + 0.15);

        const filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 1000;

        noise.connect(filter);
        filter.connect(noiseGain);
        noiseGain.connect(masterGain);
        noise.start(time);
        noise.stop(time + 0.15);

        // Tone body
        const osc = audioCtx.createOscillator();
        const oscGain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(200, time);
        osc.frequency.exponentialRampToValueAtTime(80, time + 0.05);
        oscGain.gain.setValueAtTime(0.5, time);
        oscGain.gain.exponentialRampToValueAtTime(0.001, time + 0.08);
        osc.connect(oscGain);
        oscGain.connect(masterGain);
        osc.start(time);
        osc.stop(time + 0.08);
      }

      function playHiHat(time) {
        const bufferSize = audioCtx.sampleRate * 0.05;
        const buffer = audioCtx.createBuffer(
          1,
          bufferSize,
          audioCtx.sampleRate,
        );
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;

        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.3, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

        const hp = audioCtx.createBiquadFilter();
        hp.type = 'highpass';
        hp.frequency.value = 5000;

        const bp = audioCtx.createBiquadFilter();
        bp.type = 'bandpass';
        bp.frequency.value = 10000;

        noise.connect(hp);
        hp.connect(bp);
        bp.connect(gain);
        gain.connect(masterGain);
        noise.start(time);
        noise.stop(time + 0.05);
      }

      function playTone(
        note,
        octave,
        time,
        type = 'sine',
        duration = 0.15,
        attack = 0.01,
        release = 0.1,
      ) {
        const freq = noteFreq(note, octave);
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(0.3, time + attack);
        gain.gain.linearRampToValueAtTime(0.001, time + duration);
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(time);
        osc.stop(time + duration + 0.01);
      }

      function playFX(time) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800, time);
        osc.frequency.exponentialRampToValueAtTime(200, time + 0.2);
        gain.gain.setValueAtTime(0.15, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(time);
        osc.stop(time + 0.2);
      }

      function playInstrument(instId, time, step) {
        if (muted[instId]) return;
        const vol = volumes[instId];

        switch (instId) {
          case 'kick':
            playKick(time);
            break;
          case 'snare':
            playSnare(time);
            break;
          case 'hihat':
            playHiHat(time);
            break;
          case 'bass': {
            const n = getStepNote('bass', step);
            playTone(n.note, n.octave, time, 'sawtooth', 0.2, 0.005, 0.15);
            break;
          }
          case 'synth1': {
            const n = getStepNote('synth1', step);
            playTone(n.note, n.octave, time, 'square', 0.15, 0.01, 0.1);
            break;
          }
          case 'synth2': {
            const n = getStepNote('synth2', step);
            playTone(n.note, n.octave, time, 'triangle', 0.12, 0.005, 0.08);
            break;
          }
          case 'pad': {
            const n = getStepNote('pad', step);
            playTone(n.note, n.octave, time, 'sine', 0.5, 0.05, 0.3);
            break;
          }
          case 'fx':
            playFX(time);
            break;
        }
      }

      // Play chord on piano
      function playChord(notes, octave) {
        initAudio();
        const now = audioCtx.currentTime;
        notes.forEach((note, i) => {
          playTone(note, octave, now, 'triangle', 0.5, 0.02, 0.3);
        });
      }

      // Play single note on piano
      function playNote(note, octave) {
        initAudio();
        playTone(
          note,
          octave,
          audioCtx.currentTime,
          'triangle',
          0.3,
          0.01,
          0.2,
        );
      }

      // ============== SEQUENCER ==============
      let isPlaying = false;
      let currentStep = -1;
      let bpm = 120;
      let swing = 0;
      let nextNoteTime = 0;
      let timerID = null;

      function getStepTime(step) {
        const beatTime = 60.0 / bpm / 4; // 16th note
        const swingAmount = swing / 100;
        if (step % 2 === 1) {
          return beatTime * (1 + swingAmount * 0.5);
        }
        return beatTime * (1 - swingAmount * 0.25);
      }

      function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
          currentStep = (currentStep + 1) % STEPS;

          instruments.forEach((inst) => {
            if (grid[inst.id][currentStep]) {
              playInstrument(inst.id, nextNoteTime, currentStep);
            }
          });

          // Visual update
          const step = currentStep;
          setTimeout(
            () => highlightStep(step),
            (nextNoteTime - audioCtx.currentTime) * 1000,
          );

          nextNoteTime += getStepTime(currentStep);
        }
        timerID = setTimeout(scheduler, 25);
      }

      function startSequencer() {
        initAudio();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isPlaying = true;
        currentStep = -1;
        nextNoteTime = audioCtx.currentTime;
        scheduler();
        document.getElementById('playBtn').classList.add('playing');
        document.getElementById('playBtn').textContent = '‚èπ';
      }

      function stopSequencer() {
        isPlaying = false;
        clearTimeout(timerID);
        currentStep = -1;
        highlightStep(-1);
        document.getElementById('playBtn').classList.remove('playing');
        document.getElementById('playBtn').textContent = '‚ñ∂';
      }

      function highlightStep(step) {
        document.querySelectorAll('.beat-cell').forEach((cell) => {
          cell.classList.remove('playing-col');
        });
        if (step >= 0) {
          document
            .querySelectorAll(`.beat-cell[data-step="${step}"]`)
            .forEach((cell) => {
              cell.classList.add('playing-col');
            });
        }
      }

      // ============== BUILD UI ==============
      function buildBeatMarkers() {
        const container = document.getElementById('beatMarkers');
        container.innerHTML = '';
        for (let i = 0; i < STEPS; i++) {
          const m = document.createElement('div');
          m.className = 'beat-marker' + (i % 4 === 0 ? ' downbeat' : '');
          m.textContent = i % 4 === 0 ? i / 4 + 1 : '¬∑';
          container.appendChild(m);
        }
      }

      function buildGrid() {
        const container = document.getElementById('drumGrid');
        container.innerHTML = '';

        instruments.forEach((inst) => {
          const row = document.createElement('div');
          row.className = 'instrument-row';

          // Label
          const label = document.createElement('div');
          label.className = 'instrument-label';
          label.innerHTML = `<span class="instrument-dot" style="background:${inst.color}"></span>${inst.name}`;
          row.appendChild(label);

          // Cells
          for (let s = 0; s < STEPS; s++) {
            if (s > 0 && s % 4 === 0) {
              const div = document.createElement('div');
              div.className = 'section-divider';
              row.appendChild(div);
            }

            const cell = document.createElement('div');
            cell.className = 'beat-cell';
            cell.dataset.inst = inst.id;
            cell.dataset.step = s;

            if (grid[inst.id][s]) {
              cell.classList.add('active');
              cell.style.background = inst.color;
              cell.style.boxShadow = `0 0 8px ${inst.color}40`;
            }

            cell.addEventListener('mousedown', (e) => {
              initAudio();
              const on = !grid[inst.id][s];
              grid[inst.id][s] = on;

              if (on) {
                cell.classList.add('active');
                cell.style.background = inst.color;
                cell.style.boxShadow = `0 0 8px ${inst.color}40`;
                playInstrument(inst.id, audioCtx.currentTime, s);
              } else {
                cell.classList.remove('active');
                cell.style.background = '';
                cell.style.boxShadow = '';
              }
            });

            row.appendChild(cell);
          }

          // Volume + Mute
          const controls = document.createElement('div');
          controls.className = 'instrument-controls';

          const vol = document.createElement('input');
          vol.type = 'range';
          vol.className = 'vol-slider';
          vol.min = 0;
          vol.max = 100;
          vol.value = 70;
          vol.addEventListener('input', () => {
            volumes[inst.id] = vol.value / 100;
          });

          const muteBtn = document.createElement('button');
          muteBtn.className = 'mute-btn';
          muteBtn.textContent = 'üîä';
          muteBtn.addEventListener('click', () => {
            muted[inst.id] = !muted[inst.id];
            muteBtn.textContent = muted[inst.id] ? 'üîá' : 'üîä';
            muteBtn.classList.toggle('muted');
          });

          controls.appendChild(vol);
          controls.appendChild(muteBtn);
          row.appendChild(controls);

          container.appendChild(row);
        });
      }

      function buildPiano() {
        const container = document.getElementById('pianoKeys');
        container.innerHTML = '';

        const scaleNotes = getScaleNotes(currentKey, currentScale);
        const keyMap = 'awsedftgyhujk';
        let keyIdx = 0;

        for (let i = 0; i < 13; i++) {
          const noteIdx = i % 12;
          const isBlack = [1, 3, 6, 8, 10].includes(noteIdx);

          const key = document.createElement('div');
          key.className = `piano-key ${isBlack ? 'black' : 'white'}`;

          const inScale = scaleNotes.includes(noteIdx);
          if (inScale) key.classList.add('in-scale');

          const octave = currentOctave + (i >= 12 ? 1 : 0);
          key.dataset.note = noteIdx;
          key.dataset.octave = octave;

          if (!isBlack) {
            key.textContent = NOTE_NAMES[noteIdx];
            if (keyIdx < keyMap.length) {
              key.title = `Key: ${keyMap[keyIdx].toUpperCase()}`;
            }
          }

          key.addEventListener('mousedown', () => {
            key.classList.add('pressed');
            playNote(noteIdx, octave);
          });
          key.addEventListener('mouseup', () =>
            key.classList.remove('pressed'),
          );
          key.addEventListener('mouseleave', () =>
            key.classList.remove('pressed'),
          );

          container.appendChild(key);
          if (!isBlack) keyIdx++;
        }
      }

      function buildChords() {
        const container = document.getElementById('chordDisplay');
        container.innerHTML = '';

        const chords = getChords(currentKey, currentScale);
        chords.forEach((chord) => {
          const btn = document.createElement('button');
          btn.className = 'chord-btn';
          btn.innerHTML = `${chord.name}<span class="roman">${chord.roman}</span>`;
          btn.addEventListener('click', () =>
            playChord(chord.notes, currentOctave),
          );
          container.appendChild(btn);
        });
      }

      // ============== SELECTORS ==============
      function buildSelectors() {
        const keySelect = document.getElementById('keySelect');
        NOTE_NAMES.forEach((name, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = name;
          keySelect.appendChild(opt);
        });
        keySelect.addEventListener('change', () => {
          currentKey = parseInt(keySelect.value);
          buildPiano();
          buildChords();
        });

        const scaleSelect = document.getElementById('scaleSelect');
        Object.keys(SCALES).forEach((name) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          scaleSelect.appendChild(opt);
        });
        scaleSelect.addEventListener('change', () => {
          currentScale = scaleSelect.value;
          buildPiano();
          buildChords();
        });

        document
          .getElementById('octaveSelect')
          .addEventListener('change', (e) => {
            currentOctave = parseInt(e.target.value);
            buildPiano();
          });
      }

      // ============== SIDEBAR CONTENT ==============
      const learnContent = [
        {
          title: 'What is a Beat?',
          tag: 'Basics',
          summary:
            'A beat is the basic unit of time in music ‚Äî like a pulse or heartbeat.',
          detail: `<strong>The grid above has 16 steps</strong> = one "bar" of music. Each row of 4 steps = one beat. At 120 BPM, each beat lasts 0.5 seconds.\n\n<strong>Try this:</strong> Click every 1st cell in the Kick row (steps 1, 5, 9, 13) for a classic "four on the floor" pattern. This is the foundation of house and dance music!`,
        },
        {
          title: 'Rhythm Patterns',
          tag: 'Rhythm',
          summary:
            'Different combinations of beats and rests create different grooves.',
          detail: `<strong>Kick on 1 & 3, Snare on 2 & 4</strong> = basic rock beat. The snare on beats 2 and 4 is called the "backbeat" ‚Äî it's what makes you nod your head.\n\n<strong>Hi-hats</strong> fill in the gaps and add energy. Try them on every step (1/16th notes) or every other step (1/8th notes) for different feels.\n\n<strong>Swing</strong> makes notes slightly uneven ‚Äî giving a jazzy, bouncy feel. Try the swing slider!`,
        },
        {
          title: 'What is BPM?',
          tag: 'Tempo',
          summary: 'Beats Per Minute ‚Äî how fast or slow your music plays.',
          detail: `<strong>Common BPM ranges:</strong>\n‚Ä¢ 60-80: Chill, lo-fi, ballads\n‚Ä¢ 90-110: Hip hop, R&B\n‚Ä¢ 120-130: House, pop\n‚Ä¢ 140-160: Drum & bass, dubstep\n‚Ä¢ 170+: Jungle, speedcore\n\nTry changing the BPM while playing to feel the difference!`,
        },
        {
          title: 'Keys & Scales',
          tag: 'Theory',
          summary:
            'A scale is a set of notes that sound good together. The key tells you which note is "home."',
          detail: `<strong>Major scales</strong> sound happy and bright. <strong>Minor scales</strong> sound sad or moody.\n\nThe orange dots on the piano show which notes are in the current scale. Try playing only the orange-dotted keys ‚Äî they'll always sound good together!\n\n<strong>Pentatonic</strong> (5 notes) is the easiest scale to improvise with ‚Äî almost impossible to hit a "wrong" note.`,
        },
        {
          title: 'What are Chords?',
          tag: 'Theory',
          summary:
            'A chord is 3+ notes played at the same time, creating harmony.',
          detail: `<strong>The chord buttons below the piano</strong> show chords that fit in your chosen key/scale.\n\n<strong>Roman numerals (I, ii, IV, V)</strong> show the chord's position. Uppercase = major (happy), lowercase = minor (sad).\n\n<strong>Try this progression:</strong> Click I ‚Üí V ‚Üí vi ‚Üí IV. This is the most popular chord progression in pop music! ("Let It Go", "No Woman No Cry", etc.)`,
        },
        {
          title: 'Layering Sounds',
          tag: 'Production',
          summary:
            'Great beats come from layering different instruments with different roles.',
          detail: `<strong>Think in layers:</strong>\n‚Ä¢ <strong>Kick</strong>: The foundation, the thump\n‚Ä¢ <strong>Snare</strong>: The crack, provides rhythm\n‚Ä¢ <strong>Hi-hat</strong>: Energy and movement\n‚Ä¢ <strong>Bass</strong>: Low frequency, adds depth\n‚Ä¢ <strong>Synth</strong>: Melody and color\n‚Ä¢ <strong>Pad</strong>: Atmosphere, fills space\n\nStart with drums, then add bass, then melody. Less is often more!`,
        },
        {
          title: 'Muting & Volume',
          tag: 'Mix',
          summary:
            'Control the balance of your instruments with volume and mute.',
          detail: `<strong>Use the volume sliders</strong> on each row to balance your mix. Not everything should be at max volume!\n\n<strong>Muting</strong> (üîä button) lets you temporarily silence a track to hear how the others sound together. Producers call this "soloing" ‚Äî mute everything except one track to hear it clearly.\n\n<strong>Tip:</strong> If something sounds muddy, try turning down the volume rather than removing notes.`,
        },
      ];

      const presetContent = [
        {
          name: 'Basic Rock',
          desc: 'Classic rock pattern: kick-snare with 8th note hi-hats',
          pattern: {
            kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
            snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
            hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
          },
        },
        {
          name: 'House',
          desc: 'Four-on-the-floor kick with offbeat hi-hats',
          pattern: {
            kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
            snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
            hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
            bass: [1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0],
          },
        },
        {
          name: 'Hip Hop',
          desc: 'Boom bap pattern with swing feel',
          pattern: {
            kick: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0],
            snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
            hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
          },
          swing: 40,
        },
        {
          name: 'Lo-fi Chill',
          desc: 'Relaxed beat with pad and synth layers',
          pattern: {
            kick: [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
            hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1],
            pad: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            synth1: [0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0],
          },
          bpm: 85,
          swing: 30,
        },
        {
          name: 'Drum & Bass',
          desc: 'Fast breakbeat with rolling bass',
          pattern: {
            kick: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
            snare: [0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0],
            hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
            bass: [1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1],
          },
          bpm: 174,
        },
        {
          name: 'Techno',
          desc: 'Driving 4/4 with synth stabs',
          pattern: {
            kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
            hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
            synth1: [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1],
            bass: [1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0],
            fx: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
          },
          bpm: 130,
        },
      ];

      const tipsContent = [
        {
          title: 'üéØ Start Simple',
          text: 'Begin with just kick and snare. Add hi-hats next. Then layer in bass and melody. Building complexity step by step creates better results than filling everything at once.',
        },
        {
          title: 'üéµ The Rule of Repetition',
          text: 'Music needs patterns. Humans enjoy predictability with small surprises. Make a basic 4-beat pattern, then change just 1-2 cells on the repeat for variation.',
        },
        {
          title: 'üîá Space is Music',
          text: 'Empty cells matter! Silence creates rhythm just as much as sound. If something sounds cluttered, try removing notes rather than adding more.',
        },
        {
          title: 'üéπ Keyboard Shortcuts',
          text: 'Press Space to play/stop. Use A through L keys to play the piano. This lets you quickly test melodies and ideas without clicking.',
        },
        {
          title: 'üé≤ Happy Accidents',
          text: 'Click the random button to generate patterns, then edit what you hear. Often the best music comes from modifying random ideas rather than starting from scratch.',
        },
        {
          title: 'üìê Quantization',
          text: 'The grid is "quantized" ‚Äî everything snaps to exact time divisions. This is why sequenced music sounds tight and precise. The swing control adds human-like imperfection.',
        },
      ];

      function renderSidebar(tab) {
        const container = document.getElementById('sidebarContent');
        container.innerHTML = '';

        if (tab === 'learn') {
          learnContent.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'learn-card';
            card.innerHTML = `
        <h3>${item.title} <span class="tag">${item.tag}</span></h3>
        <p>${item.summary}</p>
        <div class="detail">${item.detail.replace(/\n/g, '<br>')}</div>
      `;
            card.addEventListener('click', () =>
              card.classList.toggle('expanded'),
            );
            container.appendChild(card);
          });
        } else if (tab === 'presets') {
          presetContent.forEach((preset) => {
            const btn = document.createElement('button');
            btn.className = 'preset-btn';
            btn.innerHTML = `${preset.name}<span>${preset.desc}</span>`;
            btn.addEventListener('click', () => loadPreset(preset));
            container.appendChild(btn);
          });
        } else if (tab === 'tips') {
          tipsContent.forEach((tip) => {
            const card = document.createElement('div');
            card.className = 'learn-card';
            card.innerHTML = `<h3>${tip.title}</h3><p>${tip.text}</p>`;
            container.appendChild(card);
          });
        }
      }

      function loadPreset(preset) {
        // Clear all
        instruments.forEach(
          (inst) => (grid[inst.id] = new Array(STEPS).fill(false)),
        );

        // Load pattern
        Object.entries(preset.pattern).forEach(([id, pattern]) => {
          grid[id] = pattern.map((v) => !!v);
        });

        // Apply settings
        if (preset.bpm) {
          bpm = preset.bpm;
          document.getElementById('bpmInput').value = bpm;
        }
        if (preset.swing !== undefined) {
          swing = preset.swing;
          document.getElementById('swingSlider').value = swing;
          document.getElementById('swingVal').textContent = swing + '%';
        }

        buildGrid();

        // Auto-play
        if (!isPlaying) {
          startSequencer();
        }
      }

      // ============== RANDOM PATTERN ==============
      function randomPattern() {
        instruments.forEach((inst) => {
          grid[inst.id] = new Array(STEPS).fill(false);

          const density = inst.type === 'drum' ? 0.3 : 0.15;
          for (let s = 0; s < STEPS; s++) {
            // Make downbeats more likely
            const boost = s % 4 === 0 ? 0.2 : 0;
            grid[inst.id][s] = Math.random() < density + boost;
          }

          // Ensure kick on beat 1
          if (inst.id === 'kick') grid[inst.id][0] = true;
        });

        buildGrid();

        if (!isPlaying) startSequencer();
      }

      // ============== VISUALIZER ==============
      function drawVisualizer() {
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth * 2;
        canvas.height = canvas.parentElement.clientHeight * 2;
        ctx.scale(2, 2);
        const W = canvas.width / 2;
        const H = canvas.height / 2;

        function draw() {
          ctx.clearRect(0, 0, W, H);

          if (analyser) {
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);

            const barW = W / data.length;

            ctx.fillStyle = 'rgba(255,107,61,0.08)';
            ctx.fillRect(0, 0, W, H);

            for (let i = 0; i < data.length; i++) {
              const v = data[i] / 255;
              const h = v * H;

              const gradient = ctx.createLinearGradient(0, H - h, 0, H);
              gradient.addColorStop(0, `rgba(255,107,61,${0.6 * v})`);
              gradient.addColorStop(1, 'rgba(255,107,61,0.05)');

              ctx.fillStyle = gradient;
              ctx.fillRect(i * barW, H - h, barW - 1, h);
            }
          }

          requestAnimationFrame(draw);
        }

        draw();
      }

      // ============== KEYBOARD INPUT ==============
      const keyboardMap = {
        a: 0,
        w: 1,
        s: 2,
        e: 3,
        d: 4,
        f: 5,
        t: 6,
        g: 7,
        y: 8,
        h: 9,
        u: 10,
        j: 11,
        k: 12,
      };

      document.addEventListener('keydown', (e) => {
        if (e.key === ' ') {
          e.preventDefault();
          isPlaying ? stopSequencer() : startSequencer();
          return;
        }

        const noteOffset = keyboardMap[e.key.toLowerCase()];
        if (noteOffset !== undefined && !e.repeat) {
          const note = noteOffset % 12;
          const oct = currentOctave + (noteOffset >= 12 ? 1 : 0);
          playNote(note, oct);

          // Highlight key
          const keys = document.querySelectorAll('.piano-key');
          if (keys[noteOffset]) {
            keys[noteOffset].classList.add('pressed');
            setTimeout(() => keys[noteOffset].classList.remove('pressed'), 200);
          }
        }
      });

      // ============== INIT ==============
      function init() {
        buildSelectors();
        buildBeatMarkers();
        buildGrid();
        buildPiano();
        buildChords();
        renderSidebar('learn');
        drawVisualizer();

        // Play/Stop
        document.getElementById('playBtn').addEventListener('click', () => {
          isPlaying ? stopSequencer() : startSequencer();
        });

        // BPM
        document.getElementById('bpmInput').addEventListener('input', (e) => {
          bpm = Math.max(40, Math.min(240, parseInt(e.target.value) || 120));
        });

        // Swing
        document
          .getElementById('swingSlider')
          .addEventListener('input', (e) => {
            swing = parseInt(e.target.value);
            document.getElementById('swingVal').textContent = swing + '%';
          });

        // Clear
        document.getElementById('clearBtn').addEventListener('click', () => {
          instruments.forEach(
            (inst) => (grid[inst.id] = new Array(STEPS).fill(false)),
          );
          buildGrid();
        });

        // Random
        document
          .getElementById('randomBtn')
          .addEventListener('click', randomPattern);

        // Sidebar tabs
        document.querySelectorAll('.sidebar-tab').forEach((tab) => {
          tab.addEventListener('click', () => {
            document
              .querySelectorAll('.sidebar-tab')
              .forEach((t) => t.classList.remove('active'));
            tab.classList.add('active');
            renderSidebar(tab.dataset.tab);
          });
        });

        // Resize
        window.addEventListener('resize', () => {
          drawVisualizer();
        });
      }

      init();
    </script>
  </body>
</html>
